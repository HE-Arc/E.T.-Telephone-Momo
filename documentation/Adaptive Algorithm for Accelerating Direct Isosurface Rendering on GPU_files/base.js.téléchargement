/**
 * 定义全局变量
 * local:当前地址栏URL
 * contextPath:项目名称，在服务器上可能没有项目名称，注意发布前修正
 * basePath:项目内容根路径，用于引入图片或者css样式，同contextPath
 * local_host:域名内容，例如: http://localhost:8080/scxb，用于action
 * web_basePath:项目内容路径(服务器发布)
 * web_host:域名内容，例如：http://www.rhhz.net
 * */
var local = window.location;  
var contextPath = local.pathname.split("/")[1];
var messageTimer=null;//显示动态消息

//本地使用
var basePath = local.protocol+"//"+local.host+"/"+contextPath;
var local_host="http://"+local.host+"/";

//ajax 参数
var ajaxArg={
	url : "",   //url 路径
	data : {},  //data 传送数据
	extraDate : null, //主要用于回调函数使用
	returnFun:"" //回调函数
};
/**
 * ajax 公共方法
 */
function ajaxPost(ajaxArg){
	$.ajax({
		type:'post',
		url:ajaxArg.url,
		data:ajaxArg.data,
		dataType:'json',
		success:function(data){
			ajaxArg.returnFun(data,ajaxArg.extraDate);
		},
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			console.info("----- submit search error ---");
			console.info("----- XMLHttpRequest.responseText ---"+XMLHttpRequest.responseText);
			console.info("----- XMLHttpRequest.status ---"+XMLHttpRequest.status);
			console.info("----- XMLHttpRequest.readyState ---"+XMLHttpRequest.readyState);
			console.info("----- textStatus ---"+textStatus);
		}
	})
};
$(function(){
	
	try{
		//主动给百度推送URL代码
		var bp = document.createElement('script');
		var curProtocol = window.location.protocol.split(':')[0];
		if (curProtocol === 'https'){
			bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
		}
		else{
			bp.src = 'http://push.zhanzhang.baidu.com/push.js';
		}
		var s = document.getElementsByTagName("script")[0];
		s.parentNode.insertBefore(bp, s);
	}catch(e){
		console.log(e);
	}
	
	//初始化字符串截取
	$(".require_sub").subTextMax({trim:false});
	//截取并添加title
	$(".require_sub_add_title").subTextMax({trim:false,add_title:true});
	//初始化查询结果页摘要截取效果，设置默认trim，保留长度，不添加title，截取内容类型为html
	$(".search-article-abstract").subTextMax({trim:false,keep_len:300,add_title:false,content_type:'html'});
	
	//$(".fig-tit").subTextMax({trim:false,keep_len:50,add_title:true});
	//除首页外，其他页面左侧菜单下显示二维码
	var currentPageView = $("#pageViewId").length > 0 ? $("#pageViewId").val():"";
	if(currentPageView != "首页") {
		$(".second-level-code").show();
	}
	if(typeof(advSetting) != "undefined"){
		getCommonAd(advSetting);
	} 

	//重新渲染js效果
	refreshAfterAjaxLoad();
	//访问者数量
	if($(".accessCount").length>0){
		accessCount();
	}
	if($("#newsId").length>0){
		addNewsRecords();
	}
	
	//加载citedBy信息
	loadArticleCitedByIds();
})

/**
 * 通用广告查询方法
 * @param setting
 * @return
 */
function getCommonAd(setting){
	if(setting != undefined){
		var ajaxArg={
			url : local_host +"common/adv",   										//url 路径
			data : {'columnName':setting.columnName,'size':setting.size},  			//data 传送数据
			returnFun:setting.callback 												//回调函数
		};
		ajaxPost(ajaxArg);
	}
}
/**
 * 批量查询文章计量信息
 * @return
 */
function loadArticleMetricByIds(){
	var idArray = [] ;
	$(".article-list").each(function(i,e){
		var articleId = $(e).attr("id");
		if(!isNull(articleId)){
			idArray.push(articleId);
		}
	})
	if(idArray.length > 0){
		var ids = idArray.toString();
		var ajaxArg={
			url: local_host +"article/getArticleMetric",   										
			data: {'articleIds':ids},
			returnFun:outArticleMetric 																		
		};
		ajaxPost(ajaxArg);
	}
}

/**
 * 输出列表中的文章计量信息
 * @param data
 * @param indexArray
 * @return
 */
function outArticleMetric(data){
	if(typeof(data) != "undefined"){
		$.each(data,function(i,e){
			$("#"+e.articleId).find(".abs-num").text(e.viewCount);
			$("#"+e.articleId).find(".html-num").text(e.htmlViewCount);
			$("#"+e.articleId).find(".pdf-num").text(e.pdfDownCount);
		})
	}
}

/**
 * ajax加载页面/数据后需要重新渲染的js效果
 * 如$(function())中执行的代码
 * 如插件调用代码 mathJax.js  rhhz.js
 * @return
 */
function refreshAfterAjaxLoad(){
	//再次渲染字符串截取
	$(".require_sub").subTextMax({trim:false});
	//TOP
	$("#title a").each(function(index){
        $(this).mouseover(function(){
          $("#title .titsh").removeClass("titsh");
          $("#content .consh").removeClass("consh");
          $(this).addClass("titsh");
          $("#content>div:eq("+index+")").addClass("consh");
        })
	})
	//加载文章列表计量信息
	loadArticleMetricByIds();
	//加载优先发表状态
	loadArticleReleaseInfoByIds();
	//再次渲染字符串截取
	$(".require_sub").subTextMax({trim:false})
	//再次点击回到顶部
	$(".bottom-backTop").click(function(){
        $("html,body").animate({scrollTop:0},500);
    })
    // colorbox 弹出框
    $(".group2").colorbox({rel:'group2',width:'90%',height:"75%",opacity:'0.8'});
}


/**
 * 批量查询文章发布状态信息
 * @return
 */
function loadArticleReleaseInfoByIds(){
	var idArray = [] ;
	$(".article-list-latest").each(function(i,e){
		var articleId = $(e).attr("id");
		if(!isNull(articleId)){
			idArray.push(articleId);
		}
	})
	
	if(idArray.length > 0){
		var ids = idArray.toString();
		var ajaxArg={
			url: local_host +"article/getArticleReleaseProgress",
			data: {'articleIds':ids},
			returnFun:outArticleReleaseInfo
		};
		ajaxPost(ajaxArg);
	}
}

/**
 * 输出列表中的文章状态信息
 * @param data
 * @param indexArray
 * @return
 */
function outArticleReleaseInfo(data){
	if(typeof(data) != "undefined" && data != null){
		$.each(data,function(i,e){
			$("#"+e.articleId).find(".current_state").html(e.currentState);
			$("#"+e.articleId).find(".current_state_en").html(e.currentStateEn);
			$("#"+e.articleId).find(".latest_update").html(e.lastReleaseTime);
			$("#"+e.articleId).find(".latest_update_span").show();
		})
	}
}
/**
 * 加载访问者数量
 * @return
 */
function accessCount(){
	$.ajax({
		type:'post',
		url:local_host+"tongji/getBaiDuTongJi",
		data:"",
		dataType:'json',
		success:function(res){
    		var jsonObj = jQuery.parseJSON(res);
    		var json = jsonObj.body.data[0].result.items;
    		if(json != undefined && json != "" ){
	    		//pv_count 浏览次数 ，visitor_count 访问者数量 ， ip_count ip访问数量（按顺序）
	    		var resFilds = jsonObj.body.data[0].result.fields;
	    		var fild = "";
	    		var ipArea = "";
	    		var result = "";
	    		for(var i = 0;i< resFilds.length;i++){
					 if(resFilds[i] == "visitor_count"){
						 fild = i-1;
					 }
				}
	    		for(var i = 0;i< json.length;i++){
	    			var jValue=json[i];
	    				if(i == 0){
	    					for(var j = 0;j< jValue.length;j++){
		    					if(local_host.indexOf(jValue[j][0].name)>0){
		    						ipArea = j;
		    					}
	    					}
	    				}else{
	    					for(var j = 0;j< jValue.length;j++){
	    						var jcount = jValue[j];
	    						if(ipArea == j){
			    					result = jcount[fild];
	    						}
		    				}
	    					jValue[ipArea];
	    				}
	    		}
	    		$(".accessCount").html(result);
			}
		}
	})
}
/**
 * 复制引用信息到剪切板
 * @return
 */
function copyArticle(obj) {
    var info = $(obj).parent(".modal-footer").siblings(".copyCitationInfo").text().trim();
    copyToClipboard(info);
}
function copyArticle2(obj) {
    var info = $(obj).parents("table").siblings(".copyCitationInfo").text().trim();
    copyToClipboard(info,obj);
}
/**
 * 将信息复制到剪切板
 * @param info
 * @return
 */
function copyToClipboard(info,obj){
    var oInput = document.createElement('input');
    oInput.value = info;
    document.body.appendChild(oInput);   
    setTimeout(
    	function(){
    		$(oInput).select(); // 选择对象	
    		document.execCommand("Copy");
		    oInput.className = 'oInput';
		    oInput.style.display='none';
			if($(obj).parents("table").siblings(".copyCitationInfo").hasClass("copyCitationInfo-en") || $("#language").val()=="en"){
				alert("copy citation success");
			}else{
				alert("复制成功");
			}
    	},500);
}

/**
 * 直接初始化弹出框
 */
$(function(){
	// 英文文章详情页Get Citation弹出
	$(".download-btn").click(function(){
		$("#exportCitationModal").css({"opacity":"1"})
	});
	// colorbox 弹出框
    $(".group2").colorbox({rel:'group2',width:'90%',height:"75%",opacity:'0.8'});
	$(".group3").colorbox({rel:'group3',width:'90%',height:"75%",opacity:'0.8',
    	onComplete:function(){
    		$("#cboxTitle").niceScroll({  
    	        cursorcolor:"transparent",  
    	        cursoropacitymax:1,  
    	        touchbehavior:false,  
    	        cursorwidth:"5px",  
    	        cursorborder:"0",  
    	        cursorborderradius:"5px"  
    	    });
    		//渲染数学公式
   			//MathJax.Hub.Queue(["Typeset", MathJax.Hub]);

	}
    });
    $(".group4").colorbox({rel:'group4',width:'90%',height:"75%",opacity:'0.8',inline:true});
    // 解决文章详情页图片公式路径问题，以前的只针对全文公式
    var allPath=$("#allSrc").val();
    if(allPath != undefined){
		if($(".article-abstract img,.article-info-en img").length>0){
			$(".article-abstract img,.article-info-en img").each(function(){
				var src=$(this).attr("src");
				$(this).attr({"src":allPath+src});
			})
		}
    }
})
/**
 * 关系图
 * @param type
 * @param q
 * @return
 */
function getRelationship(){
        var url = local_host + "article/getRelationship";
        var myChart = "";
    	$.ajax({
    		type:'post',
    		url:url,
    		data:{'id':$("#articleId").val()},
    		async: false,
    		dataType:'json',
    		success:function(dataMap){
    			var webkitDep = null;
				for(var key in dataMap){
					if(key == "keyword"){
			        	myChart = echarts.init(document.getElementById('keywordEcharts'));
			        }else if(key == "author"){
			        	myChart = echarts.init(document.getElementById('authorEcharts'));
			        }
					/**
					if(key == "keywordCn"){
			        	myChart = echarts.init(document.getElementById('keywordCnEcharts'));
			        }else if(key == "keywordEn"){
			        	myChart = echarts.init(document.getElementById('keywordEnEcharts'));
			        }else if(key == "authorCn"){
			        	myChart = echarts.init(document.getElementById('authorCnEcharts'));
			        }else if(key == "authorEn"){
			        	myChart = echarts.init(document.getElementById('authorEnEcharts'));
			        }
			        */
					webkitDep = dataMap[key];
					myChart.showLoading({
			    		text: "Data loading..."
			        });
					myChart.hideLoading();
	        		var categories = webkitDep.categories;
	        		var categoryArray  = new Array();
	        		$(categories).each(function(i,val) {
	        			categoryArray.push(val.name);
	        		}); 
	        		//alert(sds);
	    	        var option = {
	    	            legend: {
	    	                data: categoryArray//此处的数据必须和关系网类别中name相对应
	    	            },
	    	            series: [{
	    	                type: 'graph',
	    	                layout: 'force',
	    	                animation: false,
	    	                label: {
	    	                    normal: {
	    	                        show:true,
	    	                        position: 'right'
	    	                    }
	    	                },
	    	                draggable: true,
	    	                data: webkitDep.nodes.map(function (node, idx) {
	    	                    node.id = idx;
	    	                    return node;
	    	                }),
	    	                categories: webkitDep.categories,
	    	                force: {
	    	                    edgeLength: 105,//连线的长度
	    	                    repulsion: 100  //子节点之间的间距
	    	                },
	    	                edges: webkitDep.links
	    	            }]
	    	        };
	    	        myChart.setOption(option);
	                //绑定图表节点的点击事件
	                myChart.on('click', function (param) {
	                	var option = myChart.getOption();
	                    var data = param.data;
	                    //判断节点的相关数据是否正确
	                    if (data != null && data != undefined) {
	                        if (data.url != null && data.url != undefined) {
	                            //根据节点的扩展属性url打开新页面
	                            window.open(local_host+data.url);
	                        }
	                    }
	                });
				}
        	}
    	})
    }
	
/**
 * 新闻访问量动态记录
 */
$(function(){
	var newsId = $("#newsId").val();
	if(!isNull(newsId)){
		var ajaxArg={
				url : local_host +"common/newsBrowseNum",   										
				data : {
					'newsId':newsId
				},  																		
				returnFun:refreshBrowserNum,											
			};
		ajaxPost(ajaxArg);
	}
})
/**
 * 刷新输出新闻访问次数
 * @param data
 * @return
 */
function refreshBrowserNum(data){
	$("#browseNum").text(data.browseNum);
}

/**
 * article_base.js
 *
 */

/**
 * 文章导出引用信息到文件
 * e：object，当前对象
 * */
function toExportCitation(e,pageType){
    var ids = $(e).attr("article_id");
    if(typeof(ids) == "undefined" || ids == null || ids == ""){
        ids = window.articleId;
    }
    var pageType = "";
    if($("#language").val()=="en"){
		pageType = "en";
    }else{
    	pageType = "cn";
    }
    if(ids != ""){
        //alert(ids);
        var type = $("input[name='format']:checked").val();
        //1 包含摘要   0不包含摘要
        var content = $("input[name='content']:checked").val();
        filePath=local_host+"article/exportCitation?ids="+ids+"&fileType="+type+"&isAbs="+content+"&pageType="+pageType;
        window.location.href=filePath;
        $(".li_excel_box").hide();
        $(".modal-bg").hide();
    }else{
        if($("#language").val()=="cn"){
            alert("文章信息有误，请核对！");
        }else{
            alert("Article information is wrong, please check!");
        }
    }
}



//下载xml
function toExportXML(articleId){
	window.location.href=local_host+"article/exportXML?ids="+articleId+"&downType=XML";
}

//下载xml
function toExportXML(articleId,language){
	if(language){
		language = "en";
		window.location.href=local_host+"article/exportXML?ids="+articleId+"&downType=XML"+"&language="+language;
	}else{
		window.location.href=local_host+"article/exportXML?ids="+articleId+"&downType=XML";
	}
}

/**
 * 将表格导出csv文件
 * @param tableId
 * @param type para : table 文章详情页中的图表示
 * @return
 */
function downloadCsv(id,type){
	window.location.href=local_host+"article/exportCsv?id="+id+"&type="+type;
}

//table缩略图svg不显示,识别不了&nbsp和<hr>,替换掉它们
function nbsp(el) {
    var tableSon=$(el);
    for(var i=0;i<tableSon.length;i++){
        var test=tableSon[i].innerHTML;
        test=test.replace(/&nbsp;/ig, "");
        test=test.replace(/<hr>/ig, "");
        tableSon[i].innerHTML=test;
    }
}
/**
 * 显示全文sub表格图片
 */
function createTableSub(){
	$('.table-body').find('br').remove();
	$('td').find('br').remove();
	$(".table_content table").each(function(i,e){
		var subImg = $(e).parents(".figure").find(".article_table_fullText img");
		//html2Img($(e),subImg);
	})
}
//window.onload = function(){
//	alert(123)
//	 //文章页右侧没有图时，走svg表
//    if($(".table_fig_div").attr("isShow") == 0){
//    	var temp_table = nbsp($(".table_fig_div table"));
//    	html2Img(temp_table,$(".table_fig_right"));
//    }
//}

function html2Img1(Obj,imgObj, widthW, heightH){
	var htmlContent = $(Obj).prop("outerHTML");
	var data = "data:image/svg+xml," +
	"<svg xmlns='http://www.w3.org/2000/svg' width='"+widthW+"' height='"+heightH+"'>" +
	"<foreignObject width='2000' height='100%'>" +
	"<div xmlns='http://www.w3.org/1999/xhtml' style='font-size:16px;font-family:Helvetica'>" +
	htmlContent +
	"</div>" +
	"</foreignObject>" +
	"</svg>";
	$(imgObj).attr("src",data);
}

function html2Img(Obj,imgObj){
	html2Img1(Obj, imgObj, "210", "179")
}

/**
 * 下载大图
 * @param id figureId : paragraphElementId
 * @param type para : figure 文章详情页中的图表示
 * @return
 */
function downloadImg(id,type){
	window.location.href=local_host+"article/exportImg?id="+id+"&type="+type;	
}

/**
 * 导出ppt
 * @param figName
 * @param articleId
 * @param title
 * @param titleEn
 * @return
 */
function downloadPPT(id,type){
	window.location.href=local_host+"article/exportPPT?id="+id+"&type="+type;	
}

//ajax异步加载文章的下载量、访问量
function ajaxDownVisitArticleCount() {
	if($("#articleId").length>0){
		$.ajax({
	        type: 'post',
	        url: local_host + 'article/getDownLookCount',
	        data: {'articleId': $("#articleId").val()},
	        success: function (_resultdata) {
	            if (_resultdata != "null") {
	                //下载量
	                var _downCount = _resultdata['pdfDownCount'];
	                if (null == _downCount || "" == _downCount) {
	                    _downCount = 0;
	                }
	                //访问量
	                var _viewCount = _resultdata['viewCount'];
	                if (null == _viewCount || "" == _viewCount) {
	                    _viewCount = 0;
	                }
	                //html浏览
	                var _htmlViewCount = _resultdata['htmlViewCount'];
	                if (null == _htmlViewCount || "" == _htmlViewCount) {
	                    _htmlViewCount = 0;
	                }
	                //PDF大小
	                var _pdfSize = _resultdata['pdfFileSize'];
	                if (null == _pdfSize || "" == _pdfSize) {
	                    _pdfSize = 0;
	                }
	                $("#downloadArticleCount").text(_downCount);
	                $("#visitArticleCount").text(_viewCount);
	                $("#htmlViewCount").text(_htmlViewCount);
	                $("#pdfSize").text(_pdfSize > 0 ? "(" + _pdfSize + "KB)" : "0KB");
	            }
	        }
	    })
	}
}

/**
 * 判断设备
 */
function browserRedirect() {
    var sUserAgent = navigator.userAgent.toLowerCase();  
    var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";  
    var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";  
    var bIsMidp = sUserAgent.match(/midp/i) == "midp";  
    var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";  
    var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";  
    var bIsAndroid = sUserAgent.match(/android/i) == "android";  
    var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";  
    var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";  
    //document.writeln("您的浏览设备为：");  
    if (bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM) {  
    	
    } else {  
    	var val = $('.article-nav li:contains(Full Text(HTML))').attr('articleId'); //获取
    }  
} 
browserRedirect();
/**
 * 缓存对象
 */
var cacheObj = {
    cache: {},
    set: function (content, id, val) {
        this.cache[content + id] = val
    },
    get: function (content, id, ajaxF) {
        return this.cache[content + id]
    },
    clearCache: function () {
        this.cache = {}
    }
};

/**
 * ajax获取图表数据
 * @param articleId
 */
var ajaxFigTabNum=0;
function ajaxFigTab(articleId) {
	if(ajaxFigTabNum!=0){
		return;
	}
	ajaxFigTabNum++;
    $.ajax({
        url: local_host + 'article/figTab',
        async: false,
        type: 'get',
        data: {'id': articleId},
        success: function (data) {
            if (!data.access == false) {
            	window.location.href = local_host + 'member/login';
                //alert(data.message);
            } else {
                $('#figTab').html(data)
                $(".group2").colorbox({rel:'group2',width:'90%',height:"75%",opacity:'0.8'});
                
                //重置表格是图片的方法
                setTableImg();
                //重置图表中的href链接
                resetHref();
                //去除表格是图片的border
                removeTableBorder();
                //添加弹出框标题的滚动
                $("#cboxTitle").niceScroll({  
        	        cursorcolor:"transparent",  
        	        cursoropacitymax:1,  
        	        touchbehavior:false,  
        	        cursorwidth:"5px",  
        	        cursorborder:"0",  
        	        cursorborderradius:"5px"  
        	    });
            }
        }
    });
    //渲染数学公式
    MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
}
/**
 * 加载文章发布历程信息
 */
function loadArticleReleaseProgressAjax(articleId) {
    $.ajax({
        type: 'post',
        url: local_host + 'article/loadArticleReleaseProgressAjax',
        data: {'articleId': $("#articleId").val()},
        success: function (_resultdata) {
        }
    })
}

/**
 * 统计图表数目
 * @return
 */
function loadTableAndFigureCount(){
	var figureCount = $(".article-box.article-box3 ._figclass").length;
	var tableCount = $(".article-box.article-box3 .article_table_fullText").length;
	var figTableNum = "";
	if(figureCount > 0) figTableNum += "figure("+figureCount+")";
	if(tableCount > 0) figTableNum += "table("+tableCount+")";
	$("#fig_table_num").text(figTableNum);
}

/**
 * 加载文章计量统计信息
 * @param articleId
 * @return
 */
function loadArticleMetricCount(articleId) {
    articleVisitMonth(articleId);
    articleVisitType(articleId);
    articleVisitArea(articleId);
}


//判断com-author-wrap内容如果为空，下拉三角不显示
function hideComDrop(){
	var comAuthorWrap=$(".com-author-wrap").text().trim();
	//alert(comAuthorWrap);
	if(comAuthorWrap == ""){
		$(".com-drop").hide();
	}
}
	var currentTab = "abs";     // abs(摘要) || html（全文） || fig（图表） || ref （参考文献）|| sup（附件） || rel（相关文章）
	//文章详情页调用统计功能
	//ajaxDownVisitArticleCount();
	//页面加载缩略图显示真实数据调用
    //createTableSub();
    //去除表格是图片的border
    removeTableBorder();
   //重置搜索结果页图片路径
    setTableImg();
    //调整全文中公式是图片的路径
    resetFormulaSrc();
   //隐藏通讯作者下拉箭头
    if($(".com-author-wrap").length>0){
    	hideComDrop();
    }
    currentTab = $('.article-nav ul li.current').attr("rel");
    //处理作者标签，如果以,结尾 去除最后一个,
	$("sup.authorTag,.article-author,.article-keyword").each(function(i,e){
		var tagText = $(e).text().trim();
		if(tagText.endWith(",")){
			var tagHtml = $(e).html().trim();
			$(e).html(tagHtml.substring(0,tagHtml.length - 1));
		}
	})

//重置图表中的href链接
function resetHref(){
	$(".article-box3 a[ref-type='fig']").each(function(i,e){
		var resetFigHref=$(e).attr("href");
		var resetFigureNum = Number(resetFigHref.substring(7)); //提取图的数字
		//alert(resetfigureNum);
		resetFigHref=$(e).attr({"href":"#Fig-Figure"+resetFigureNum+""});
	})
	$(".article-box3 a[ref-type='table']").each(function(i,e){
		var resetTableHref=$(e).attr("href");
		var resetTableNum = Number(resetTableHref.substring(6)); //提取表的数字
		//alert(resetfigureNum);
		resetTableHref=$(e).attr({"href":"#Fig-Table"+resetTableNum+""});
	})
}
/**
 * 调整图表内容中的图片路径
 * @return
 */
function setTableImg(){
	var path = $("#basePath").val();
    $(".table_content .graphic").each(function(i,e){
    	if($(e).attr("src").indexOf(path)===-1){
    		$(e).attr("src",path+$(e).attr("src"));
    	}
	})
}

//调整全文中公式是图片的路径
function resetFormulaSrc(){
	var path = $("#basePath").val();
	$(".formula").each(function(i,e){
		var obj = $(e).find("img");
		if(obj.length==0)return true;
		var src = obj.attr("src");
		if(src.indexOf(path)==-1){
			src = path+src;
		}
		var onerror = src.replace(/.jpg/,".png");
		obj.attr("onerror","this.onerror=null;this.src='"+onerror+"'").attr("src",src);
	})
	$("inline-formula").each(function(i,e){
		var obj = $(e).find("img");
		if(obj.length==0)return true;
		var src = obj.attr("src");
		if(src.indexOf(path)==-1){
			src = path+src.replace(/PIC\//,'');
		}
		var onerror = src.replace(/.jpg/,".png");
		obj.attr("onerror","this.onerror=null;this.src='"+onerror+"'").attr("src",src);
	});
	$("inline-formula").each(function(){
		var num=$(this).find("alternatives .graphic");
		if(num.length>1){
			$(this).find("alternatives .graphic:first").show().siblings().hide();
		}
	});
}

//判断图表中是否含有图片
function removeTableBorder(){
	var tableImg=$(".table_content table").find("img");
	tableImg.parents(".table_content table").css({"border-bottom":"0"});
}

/**
 *article.js
 * 
 */
$(document).ready(function(){
    createContents();
    if(currentTab == "html" || currentTab == "fig"){
        $(".article_ceil_wrap").find(".article_catalog span").show();
		 //目录数据
    catalogTree();
    }else{
         $(".article_ceil_wrap").find(".article_catalog span").hide();
    }
	 //去掉栏目空格
	 var str=$('.article-info-title').html(); 
	 if(str=='&nbsp;'){
		 $(".article-info-title").remove();
	 }
 
	$(".article-author span:last,.article-keyword span:last").each(function(i,e){
		var tagText = $(e).text().trim();
		if(tagText.endWith(",")){
			var tagHtml = $(e).html().trim();
			$(e).html(tagHtml.substring(0,tagHtml.length - 1));
		}
	})
    //文章详情页tab栏切换
    $('.article-nav ul li').click(function(){
        currentTab = $(this).attr("rel");
        $(this).addClass('current').siblings().removeClass('current');
         index=$(this).index();
        $('.article-box').eq(index).addClass('current').siblings().removeClass('current');
        createContents();
        if(currentTab == "html"){
        	//图表链接点击跳转大图
            //showBigFigTable();
           //渲染数学公式
	   		MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
            // colorbox 弹出框
            $(".group2").colorbox({rel:'group2',width:'90%',height:"75%",opacity:'0.8',
            	onComplete:function(){
	        		$("#cboxTitle").niceScroll({  
	        	        cursorcolor:"transparent",  
	        	        cursoropacitymax:1,  
	        	        touchbehavior:false,  
	        	        cursorwidth:"5px",  
	        	        cursorborder:"0",  
	        	        cursorborderradius:"5px"  
	        	    });
	        		//渲染数学公式
	 	   			MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
	    		}
            });
            $(".group3").colorbox({rel:'group3',width:'90%',height:"75%",opacity:'0.8',
            	onComplete:function(){
	        		$("#cboxTitle").niceScroll({  
	        	        cursorcolor:"transparent",  
	        	        cursoropacitymax:1,  
	        	        touchbehavior:false,  
	        	        cursorwidth:"5px",  
	        	        cursorborder:"0",  
	        	        cursorborderradius:"5px"  
	        	    });
	        		//渲染数学公式
	 	   			MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
	    		}
            });
            $(".group4").colorbox({rel:'group4',width:'90%',height:"75%",opacity:'0.8',inline:true,
            	onComplete:function(){
	        		removeTableBorder();
	        		$("#cboxTitle").niceScroll({  
	        	        cursorcolor:"transparent",  
	        	        cursoropacitymax:1,  
	        	        touchbehavior:false,  
	        	        cursorwidth:"5px",  
	        	        cursorborder:"0",  
	        	        cursorborderradius:"5px"  
	        	    });
	        		//渲染数学公式
	 	   			MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
	    		}
            });
        }
        if(currentTab == "html" || currentTab == "fig"){
            catalogTree();
            $(".article_ceil_wrap").find(".article_catalog span").show();
        }else{
             $(".article_ceil_wrap").find(".article_catalog span").hide();
        }
    })
    //目录导航超出显示滚动条
    $(".addScroll").niceScroll({  
        cursorcolor:"transparent",  
        cursoropacitymax:1,  
        touchbehavior:false,  
        cursorwidth:"5px",  
        cursorborder:"0",  
        cursorborderradius:"5px"  
    });

    //作者展开功能
    $(".article-authors ul li span").click(function(){
        $(this).parent().toggleClass('current').siblings().removeClass('current');      
    });
    /**目录导航**/
    $('.article_catalog').mouseover(function(){
        //$('.article_ceil_list').css({"height":"310px"});
        $('.article_ceil_list').stop().show();
    }).mouseout(function(){
        $('.article_ceil_list').stop().hide();
    })

    /**目录点击事件**/
    $(document).on("click",".article_ceil_list li a",function(){
        var articleceilaid=$(this).attr('ref');
        $('.ceilfirst li').removeClass('active');
        $(this).parent().addClass('active');
        $("html,body").animate({
           scrollTop: $(articleceilaid).offset().top-72 + "px"
        }, {
          duration: 500,
          easing: "swing"
        });
        $('.article_ceil_list').stop().hide();
    })
	 //全文中的参考文献悬浮
     var refBoxHidetimer;
     var divShowHeight = $(".div_show").height();
//     $(document).delegate(".articleBody sup","mouseenter",function(event){
//    	 if($(this).find("span.xref").length>0){
//    		 $('.div_show').remove(); 
//        	 var supText = $(this).text(); //输出格式为[2,10,13-15]
//             var refIndexs = getRefSupIndex(supText); //输出数组2,10,13,14,15
//             var refIndexsLength=refIndexs.length; //获取数组个数
//             var greenBoxW = $(this).offset().left+8;
//             var greenBoxY = $(this).offset().top+8;
//             var supRightDis=$(window).width()-greenBoxW+8;
//             
//             var html='<div class="div_show">';
//    	         html+='<table>';
//    	     for(var i = 0;i<refIndexsLength;i++){
//    	     	supLiterNum=refIndexs[i]-1;  //获取参考文献中的编号 
//    	        	var supLiter=$($('.article-box5 .article-refer tbody tr').eq(supLiterNum).children('td')[1]).text(); //获取参考文献中的内容
//    		     html +='<tr>';
//    		     html +='<td class="refer-td-first">'+refIndexs[i]+'.</td>';
//    		     html +='<td>'+supLiter+'</td>';
//    		     html +='</tr>';
//    	     }
//    	     html += '</table>';
//    	     html += '<em class="triangle-bg"></em>';
//    	     html += '<em class="triangle-border"></em>';
//    	     html += '</div>';
//    	     $('body').append(html);
//    	     if(supRightDis<600){
//            	$(".div_show").css({"width":supRightDis});
//            }
//    	    divShowHeight = $(".div_show").height();
//            greenBoxW = $(this).offset().left-10;
//            greenBoxY = $(this).offset().top-divShowHeight-10;
//            $('.div_show').css({left:greenBoxW,top:greenBoxY}).show();	
//            $("body").on("mouseenter",".div_show",function(){
//            	 clearTimeout(refBoxHidetimer);
//            });
//            $("body").on("mouseleave",".div_show",function(){
//                $('.div_show').remove();
//            });
//    	 }
//     })
//     $(document).delegate("sup","mouseleave",function(event){ 
//    	 refBoxHidetimer = setTimeout(function () {  
//    		 $('.div_show').remove(); 
//        }, 100);
//     })
	     //全文中的图表点击显示大图 
//	    $(document).delegate("a[ref-type='fig']","click",function(event){
//	    	var href = $(this).attr("href");
//	    	//阻止a链接默认行为
//	    	event.preventDefault();
//	    	$("img" + href).parent("a").click();
//	    })
//	    $(document).delegate("a[ref-type='table']","click",function(event){
//	    	var href = $(this).attr("href");
//	    	//阻止a链接默认行为
//	    	event.preventDefault();
//	    	$(".article_table_fullText>a" + href).click();
//	    })
	   //全文显示图选项、表选项下拉菜单
	    $(document).on("click",".figure .div_btn",function(){
	        $(this).parents(".figure").toggleClass('showBtn').siblings(".figure").removeClass('showBtn');      
	    });
	});

//下拉显示通讯作者信息
function showAuthor(obj){
    var openStatus =$(obj).hasClass("current");
    //alert(openStatus);
    if(openStatus){
        $(obj).removeClass("current");
        $(obj).parent(".article-author").siblings(".com-author-wrap").stop().slideUp();
    }else{
        $(obj).addClass("current");
        $(obj).parent(".article-author").siblings(".com-author-wrap").stop().slideDown();
    }
}

//滚动显示目录导航
function createContents(){
    //alert(currentTab);
    $(window).scroll(function(){
        var articlescrolltop=$(document).scrollTop();
        if(articlescrolltop>=600){
            $(".article_ceil_wrap").show();
            //$(".article-bomb-box-wrap").show();
            //$(".article-box-wrap").hide();
        }else{
            $(".article_ceil_wrap").hide();
            //$(".article-bomb-box-wrap").hide();
            //$(".article-box-wrap").show();
        } 
        $('.article_ceil_list').stop().hide();
    })
}

/**
 * 创建文档结构树
 * @return
 */
function catalogTree(){
    $(".ceilfirst").empty();
    $(".figureCeilUl").empty();
    $(".tableCeilUl").empty();
    if(currentTab == "html"){
        var html = "";
        $(".article-box span.sec-title").each(function(i,e){
            var level = $(e).attr("level");
            var href = $(e).attr("id");
            var title = $(e).text();
            html += '<li class="sec_'+level+'"><a ref="#'+href+'" href="#'+href+'">'+title+'</a></li>';
        })
        $(".ceilfirst").empty().append(html);
        var figureHtml="";
        var tableHtml="";
        $(".ceilfirst").css({"border-bottom":"1px solid #ccc"});
        $(".article-box2 .figure .figure_title a img").each(function(i,e){
            var figureHref=$(e).attr("id");
            //alert(figureHref);
            var figureNum = Number(figureHref.substring(6)); //提取图的数字
            //alert(figureNum);
            //var figureTitle=$(e).find(".figure_caption p").eq(0).text();
            figureHtml += '<li class="figureShow"><i></i><a href="#Figure'+figureNum+'" ref="#Figure'+figureNum+'">图'+figureNum+'&nbsp;(Figure'+figureNum+')</a></li>';
        })
        $(".figureCeilUl").empty().append(figureHtml);

        $(".article-box2 .figure .article_table_fullText>a").each(function(i,e){
            var tableHref=$(e).attr("id");
            //alert(tableHref);
            var tableNum = Number(tableHref.substring(5)); //提取表的数字
            //var tableTitle=$(e).find(".table_caption p").eq(0).text();
            tableHtml += '<li class="tableShow"><i></i><a href="#Table'+tableNum+'" ref="#Table'+tableNum+'">表'+tableNum+'&nbsp;(Table'+tableNum+')</a></li>';
        })
        $(".tableCeilUl").empty().append(tableHtml);

    }else{
        var figureHtml="";
        var tableHtml="";
        $(".ceilfirst").css({"border-bottom":"none"});
        $(".article-box3 .figure .figureTextBox a img").each(function(i,e){
            var figureHref=$(e).attr("id");
            var figureNum = Number(figureHref.substring(10)); //提取图的数字
            //alert(figureNum);
            //var figureTitle=$(e).find(".figure_caption p").eq(0).text();
            figureHtml += '<li class="figureShow"><i></i><a href="#Fig-Figure'+figureNum+'" ref="#Fig-Figure'+figureNum+'">Figure'+figureNum+'</a></li>';
        })
        $(".figureCeilUl").empty().append(figureHtml);

        $(".article-box3 .figure .article_table_fullText").each(function(i,e){
            var tableHref=$(e).attr("id");
            var tableNum = Number(tableHref.substring(9)); //提取表的数字
            //var tableTitle=$(e).find(".table_caption p").eq(0).text();
            tableHtml += '<li class="tableShow"><i></i><a href="#Fig-Table'+tableNum+'" ref="#Fig-Table'+tableNum+'">Table'+tableNum+'</a></li>';
        })
        $(".tableCeilUl").empty().append(tableHtml);

    } 
    if(figureHtml==""&&tableHtml==""){
    	$(".figureCeil h4").css({"display":"none"});
    }
}

//调整全文中内容中图表点击显示大图old，已弃用，部分单刊网站有使用
function showBigFigTable(){
	$(".article-box2 .xref a[ref-type='fig']").each(function(i,e){
		var figHref=$(e).attr("href");
		$(e).addClass("group3 cboxElement");
		//alert(figHref);
		var resetFigHref=$(figHref).parent("a").attr("href");
		var resetFigTitle=$(figHref).parent("a").attr("title");
		//alert(resetFigHref);
		$(e).attr("href",resetFigHref);
		$(e).attr("title",resetFigTitle);
	})
	$(".article-box2 .xref a[ref-type='table']").each(function(i,e){
		var tableHref=$(e).attr("href");
		$(e).addClass("group4 cboxElement");
		//alert(tableHref);
		var resetTableHref=$(tableHref).attr("href");
		var resetTableTitle=$(tableHref).attr("title");
		//alert(resetFigHref);
		$(e).attr("href",resetTableHref);
		$(e).attr("title",resetTableTitle);
	})
}

/**
 * 批量查询Cited by
 * @return
 */
function loadArticleCitedByIds(){
	var idArray = [] ;
	$(".article-list").each(function(i,e){
		var articleId = $(e).attr("id");
		if(!isNull(articleId)){
			idArray.push(articleId);
		}
	})
	
	if(idArray.length > 0){
		var ids = idArray.toString();
		var ajaxArg={
			url: local_host +"article/getArticleCitedBy",
			data: {'articleIds':ids},
			returnFun:outArticleCitedByInfo
		};
		ajaxPost(ajaxArg);
	}
}

/**
 * 输出列表中的文章citedBy信息
 * @param data
 * @param indexArray
 * @return
 */
function outArticleCitedByInfo(data){
	if(typeof(data) != "undefined"){
		data = jQuery.parseJSON(data);
		$.each(data,function(i,e){
			if(e.citedCount > 0){
				$("#"+e.articleId).find(".citedby-font").show();
				$("#"+e.articleId).find(".citedBy-num").html(e.citedCount);
			}
		})
	}
}

/**
 * 添加文章访问记录
 */
function getVisitInfo(id,viewType){
	var pageType = $("#language").val();
	if(!isNull(pageType)){
		$.ajax({
    		type:'post',
    		url:local_host +"article/getVisitRecord",
    		data:{'id':id,
				'viewType':viewType,
				'pageType':pageType},
    		success:function(dataMap){
    		}
		})
	}
}

/**
 * 公式和图片切换
 */
function switchFormula(){
	$(".formula-normalimg").hide();
	 var formulatext = $(".switchFormula").text();
	 //off是显示公式图片
	 if(formulatext.indexOf('off')>1){
		 $(".switchFormula").text(formulatext.replace('off', 'on'));
		 //处理段落公式
		 $(".formula tbody tr td p").hide();
		 $(".formula-labelText").hide();
		 $(".formula tbody tr td.formulaTag").hide();
		// $(".formula tbody tr td p.img-formula").show();
		 //处理行内公式
		 $(".inline-formula-span").hide();
		 $(".inline-formula-span").next().show();
		//布局外层不带p时
		 $(".MathJax").hide();
		 $("alternatives img").show();
		$(".formula tbody tr td p alternatives img").parents("p").show();
	 }else{
		 $(".switchFormula").text(formulatext.replace('on', 'off'));
		//处理段落公式
		 $(".formula tbody tr td p").show();
		 $(".formula-labelText").show();
		 $(".formula tbody tr td.formulaTag").show();
		 $(".formula tbody tr td p.img-formula").hide();
		//处理行内公式
		 $(".inline-formula-span").show();
		 $(".inline-formula-span").next().hide();
		//布局外层不带p时
		 $(".MathJax").show();
		 $(".formula tbody tr td p img").hide();
		// $("alternatives").hide();
		 
	 }
	
		setTimeout(function(){
			//中文
			 //重置行内公式图片高度
			 $("#htmlContent p inline-formula").each(function(i,e){
				 var _h = $(e).find(".inline-formula-span").height();
				 $(e).find(".inline-formula-span").next(".formula-img").css("height",_h);
			 })
			 //重置段落公式图片高度
			  $("#htmlContent table.formula").each(function(i,e){
				 var _h = $(e).find("p").height();
				 $(e).find("p.img-formula img").css("height",_h);
			 })
			 
			 // 英文
			 //重置行内公式图片高度
			 $("#FullText p inline-formula").each(function(i,e){
				 var _h = $(e).find(".inline-formula-span").height();
				 $(e).find(".inline-formula-span").next(".formula-img").css("height",_h);
			 })
			 //重置段落公式图片高度
			  $("#FullText table.formula").each(function(i,e){
				 var _h = $(e).find("p").height();
				 $(e).find("p.img-formula img").css("height",_h);
			 })
		},300)
			
		
		
	
		$(".formula-img").click(function(event){
			event.stopPropagation();
			var _src = $(this).attr("src");
			var _position = $(this).position();
			$(".formula-normalimg").show();
			$(".formula-normalimg img").attr("src",_src);
			$(".formula-normalimg").css({"top": _position.top,"left": _position.left});
		})
		$(document).click(function(event){
			$(".formula-normalimg").hide();
		})
}

/**
 * 添加新闻访问记录
 */
function addNewsRecords(){
	var newsId = $("#newsId").val();
	if(!isNull(newsId)){
		$.ajax({
    		type:'post',
    		url:local_host +"getVisitNewsRecord",
    		data:{'id':newsId},
    		success:function(dataMap){
    		}
		})
	}

}

